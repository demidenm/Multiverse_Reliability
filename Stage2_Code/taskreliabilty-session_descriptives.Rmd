---
title: "Descriptives - Session Models"
author: "<h3>by Michael Demidenko</h3>"
date: "`r format(Sys.time(), '%B %Y')`"
output:
  html_document:
    theme: united
    highlight: tango
    toc: yes
    number_sections: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    code_folding: hide
    self_contained: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
tags: []
subtitle: <h2><u>Reliability, fMRI, tasks </u></h2>
---


```{r message=FALSE, warning=FALSE, include=FALSE}
if (!require("pacman")) install.packages("pacman")

pacman::p_load(table1, tidyverse, ggplot2, knitr, kableExtra, ggpubr, lme4, sjPlot, specr, ggrain, neuRosim, emmeans, zoo, stringr, patchwork)

pal<- c("#1D91C0","#67001F","#CB181D","#78C679","#F46D43","#F7FCFD",
                 "#A6CEE3","#FD8D3C","#A6D854","#D4B9DA","#6A51A3",
                 "#7F0000","#D9D9D9","#FFF7BC","#000000","#F0F0F0",
                 "#C7EAE5","#003C30","#F16913","#FFF7FB","#8C6BB1",
                 "#C7E9B4","#762A83","#FC9272","#DF65B0","#EF3B2C",
                 "#74C476","#E5F5F9","#AE017E","#F7F7F7")


session_info = sessionInfo()
system=session_info[[1]][1]
R_vers = session_info[[1]][13]
```

Plotting function to reduce code length + simplify. Then, short function to relabel MLS weight smoothing kernel to make visually consistent, updates are:

- 3.0 --> 3.6
- 4.0 --> 4.8
- 5.0 --> 6.0
- 6.0 --> 7.2
- 7.0 --> 8.4

```{r}
create_plot <- function(dataset, y_est, type, thresh, y_min, y_max, y_lab, add_title = TRUE) {
  plot <- dataset %>%
    ggplot(aes(x = .data[[type]], y = .data[[y_est]], fill = .data[[type]], color = .data[[type]])) +
    geom_rain(alpha = .5, rain.side = 'l',
              boxplot.args = list(color = "black", outlier.shape = NA),
              boxplot.args.pos = list(
                position = ggpp::position_dodgenudge(x = .1), width = 0.1
              )) +
    facet_grid(~study) +
    ylab(y_lab) +
    ylim(y_min,y_max)+
    theme_classic() 
  
  if (add_title) {
    plot <- plot + ggtitle(paste("Distribution by", type, "category (", thresh, "mask)"))
  }
  
  plot <- plot +
    scale_fill_manual(values = pal) +
    scale_color_manual(values = pal) +
    guides(fill = 'none', color = 'none') +
    theme(text = element_text(family = "Times New Roman"),
          axis.text = element_text(size = 12, angle = 45, hjust = 1),
          axis.title = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          plot.title = element_text(size = 16))
}

by_sample_conmod <- function(dataset, y_est, y_min, y_max, y_lab) {
  
  # Define a function to create individual plots
  create_plot <- function(data, study) {
    ggplot(data, aes(x = con, y = .data[[y_est]], fill = con, color = con)) +
      geom_rain(alpha = .5, rain.side = 'l',
                boxplot.args = list(color = "black", outlier.shape = NA),
                boxplot.args.pos = list(
                  position = ggpp::position_dodgenudge(x = .1), width = 0.1
                )) +
      facet_grid(~model) +
      ylab(y_lab) +
      ylim(y_min,y_max)+
      theme_classic() +
      scale_fill_manual(values = pal) +
      scale_color_manual(values = pal) +
      guides(fill = 'none', color = 'none') +
      theme(text = element_text(family = "Times New Roman"),
            axis.text = element_text(size = 12, angle = 45, hjust = 1),
            axis.title = element_text(size = 12),
            legend.text = element_text(size = 12),
            legend.title = element_text(size = 12),
            plot.title = element_text(size = 16)) +
      ggtitle(study) 
  }
  
  # Create plots for each study using map
  plot_list <- purrr::map(c("mls", "ahrb", "abcd"), ~ dataset %>%
                            filter(study == .x) %>%
                            create_plot(.x))
  
  # Combine plots into a single patchwork object
  combined_plots <- wrap_plots(plotlist = plot_list)
  
  # Add patchwork annotations
  combined_plots 
}

update_mls_fwhm <- function(df) {
  df <- df %>%
    mutate(fwhm = case_when(
      fwhm == "fwhm-3.0" ~ "fwhm-3.6",
      fwhm == "fwhm-4.0" ~ "fwhm-4.8",
      fwhm == "fwhm-5.0" ~ "fwhm-6.0",
      fwhm == "fwhm-6.0" ~ "fwhm-7.2",
      fwhm == "fwhm-7.0" ~ "fwhm-8.4",
      TRUE ~ as.character(fwhm)  # if none of the conditions match, keep the original value
    ))
  return(df)
}

create_specr_plot <- function(summary_df, est_label) {
  plot_a = plot_curve(df = summary_df, ci = TRUE, desc = FALSE, legend = FALSE, null = 0)
  plot_b <- plot_choices(df = summary_df, choices = c("fwhm", "motion","contrast","model"), desc = F, null = 0) +
    labs(y = "Variables", x = paste("Ordered Specification Curve \n",est_label, "coefficient"))
  
  cowplot::plot_grid(plot_a, plot_b, ncol = 1, align = "v", axis = 'tblr',
                     labels = c('A', 'B'), rel_heights = c(1, 2),
                     label_fontfamily = "Times", label_size = 12)
}

calculate_summary_stats <- function(data, variable, est_type) {
  data %>%
    select(study, {{variable}}) %>% 
    group_by(study) %>% 
    summarise(
      "est_type" = est_type,
      "median" = median({{variable}}, na.rm = TRUE),
      "mean" = mean({{variable}}, na.rm = TRUE),
      "sd" = sd({{variable}}, na.rm = TRUE),
      "min" = min({{variable}}, na.rm = TRUE),
      "max" = max({{variable}}, na.rm = TRUE) 
    ) %>% 
  kbl(format = "html", 
      booktabs = TRUE) %>% 
  kable_styling(full_width = FALSE)
  
}
```

The packages are automatically loaded using `pacman`. The reported .html was last ran on the system: `r system` and R version: `r R_vers`
***
***
In the Stage 1 [PCI Registered Report](https://doi.org/10.17605/OSF.IO/NQGEH) we are focused on Individual Continouous (intraclass correlation) and the binary/continuous group similarity (jaccard and spearman). This descriptive file includes the output information for the distribution plots, min/max/mean/median of the estimates and the spec plots for each estimate time. This report is for the *between-session* estimates


**continuous**

We stated:

Aim1: *the range and distribution of median ICCs across each study (three) and analytic decision category (four) are plotted across suprathreshold task-positive and subthreshold ICCs using Rainclouds (Allen et al., 2019) and the median and standard deviation is reported in a table.*

*to visualize the ordered median ICCs across the 360 model permutations for suprathreshold task-positive and subthreshold ICCs, specification curve analyses are used (Simonsohn et al., 2020). Specifically, results across the 360 model permutations are reported using a specification curve to represent the range of estimated effects across the variable permutations. This consists of two panels: Panel A represents the ordered ICC coefficients and the ICC’s associated 95% confidence interval colored based on no significance (gray), negative (red) or positive (blue) significance from the Null (Null here is 0) and Panel B represents the analytic decisions from each of the four categories (see Table 1) that produced the median ICC estimates. In the main text, to compare the highest and lowest ICC’s produced by the model permutations, the 25th percentile and 75th percentile median ICC estimates from the 360 models are reported separately for suprathreshold task-positive and subthreshold activation (the specification curve for all ICC estimates for suprathreshold task-positive and subthreshold activation are provided as supplemental information).*

Aim2: *the range and distribution of median MSBS and MSWS across each study and analytic decision category are plotted across suprathreshold task-positive and subthreshold ICCs using Rainclouds.*

*two separate specification curve analyses report the ordered median MSBS and MSWS coefficients in one panel and the analytic decisions that produced the MSBS and MSWS estimates in a second panel separately for suprathreshold task-positive and subthreshold activation*

**group similarity**

We stated:

Aim1: *For each study, the coefficients are plotted to reflect the distribution and range of coefficients. Both Jaccard’s and Spearman correlation are reported separately.*

***
***

# Load data {.tabset}

## ABCD
```{r include=FALSE}
abcd_site13_ids <- read.csv("./../../ProgressDetails/Aim1c_Reliability/Stage2/output/ABCD/final_session_ids.csv", 
                            sep = '\t', header = FALSE)
abcd_nda <- read.csv("../../ProgressDetails/Aim1c_Reliability/Stage2/MRIQC/NDA_MIDQC_03_01_2024.csv", 
                     sep = ',') %>% 
  filter(eventname == "baseline_year_1_arm_1" | eventname == "2_year_follow_up_y_arm_1") %>% 
  select(subjectkey,eventname,interview_date,interview_age,sex, race_ethnicity)
abcd_beh <- read.csv("./../../ProgressDetails/Aim1c_Reliability/Stage2/output/ABCD/ABCD_task-MID_summ-mot-acc-rt.csv", 
                     sep = ',', header = TRUE)

# ICC
abcd_icc_subthresh <- read.csv("./output/sample-abcd_type-session_stats-est_mask-wilson-sub.tsv", sep = '\t')
abcd_icc_subthresh$study <- "abcd"
abcd_icc_suprathresh <- read.csv("./output/sample-abcd_type-session_stats-est_mask-wilson-supra.tsv", sep = '\t')
abcd_icc_suprathresh$study <- "abcd"
abcd_icc_nacc <- read.csv("./output/sample-abcd_type-run_stats-est_mask-nacc.tsv", sep = '\t')
abcd_icc_nacc$study <- "abcd"

# MSBS
abcd_bs_subthresh <- read.csv("./output/sample-abcd_type-session_stats-bs_mask-wilson-sub.tsv", sep = '\t')
abcd_bs_subthresh$study <- "abcd"
abcd_bs_suprathresh <- read.csv("output/sample-abcd_type-session_stats-bs_mask-wilson-supra.tsv", sep = '\t')
abcd_bs_suprathresh$study <- "abcd"
# MSWS
abcd_ws_subthresh <- read.csv("./output/sample-abcd_type-session_stats-ws_mask-wilson-sub.tsv", sep = '\t')
abcd_ws_subthresh$study <- "abcd"
abcd_ws_suprathresh <- read.csv("./output/sample-abcd_type-session_stats-ws_mask-wilson-supra.tsv", sep = '\t')
abcd_ws_suprathresh$study <- "abcd"

# similarity
abcd_similarity <- read.csv("./output/sample-abcd_type-session_stats-similarity.tsv", sep = '\t')
abcd_similarity$study <- "abcd"

```

## AHRB 


```{r include=FALSE}
ahrb_ids = read.csv("./../../ProgressDetails/Aim1c_Reliability/Stage2/output/AHRB/ahrb_id_full.tsv", sep = '\t', header = FALSE)
ahrb_demo = read.csv("./../../ProgressDetails/Aim1c_Reliability/Stage2/output/AHRB/ahrb_participants.tsv", sep = '\t') 
ahrb_beh <- read.csv("./../../ProgressDetails/Aim1c_Reliability/Stage2/output/AHRB/AHRB_task-MID_summ-mot-acc-rt.csv", 
                     sep = ',', header = TRUE)
# ICC
ahrb_icc_subthresh <- read.csv("./output/sample-AHRB_type-session_stats-est_mask-wilson-sub.tsv", sep = '\t')
ahrb_icc_subthresh$study <- "ahrb"
ahrb_icc_suprathresh <- read.csv("./output/sample-AHRB_type-session_stats-est_mask-wilson-supra.tsv", sep = '\t')
ahrb_icc_suprathresh$study <- "ahrb"
ahrb_icc_nacc <- read.csv("./output/sample-AHRB_type-run_stats-est_mask-nacc.tsv", sep = '\t')
ahrb_icc_nacc$study <- "ahrb"

# MSBS
ahrb_bs_subthresh <- read.csv("./output/sample-AHRB_type-session_stats-bs_mask-wilson-sub.tsv", sep = '\t')
ahrb_bs_subthresh$study <- "ahrb"
ahrb_bs_suprathresh <- read.csv("./output/sample-AHRB_type-session_stats-bs_mask-wilson-supra.tsv", sep = '\t')
ahrb_bs_suprathresh$study <- "ahrb"
# MSWS
ahrb_ws_subthresh <- read.csv("./output/sample-AHRB_type-session_stats-ws_mask-wilson-sub.tsv", sep = '\t')
ahrb_ws_subthresh$study <- "ahrb"
ahrb_ws_suprathresh <- read.csv("./output/sample-AHRB_type-session_stats-ws_mask-wilson-supra.tsv", sep = '\t')
ahrb_ws_suprathresh$study <- "ahrb"
# similarity
ahrb_similarity <- read.csv("./output/sample-AHRB_type-session_stats-similarity.tsv", sep = '\t')
ahrb_similarity$study <- "ahrb"

```

## MLS 

```{r include=FALSE}
mls_ids = read.csv("./../../ProgressDetails/Aim1c_Reliability/Stage2/output/MLS/mls_ids.tsv", sep = '\t', header = FALSE)
mls_demo = read.csv("./../../ProgressDetails/Aim1c_Reliability/Stage2/output/MLS/mls_participants.csv", sep = ',') 
mls_beh <- read.csv("./../../ProgressDetails/Aim1c_Reliability/Stage2/output/MLS/MLS_task-reward_summ-mot-acc-rt.csv", 
                     sep = ',', header = TRUE)
# ICC
mls_icc_subthresh <- read.csv("./output/sample-MLS_type-session_stats-est_mask-wilson-sub.tsv", sep = '\t')
mls_icc_subthresh$study <- "mls"
mls_icc_subthresh <- update_mls_fwhm(mls_icc_subthresh)

mls_icc_suprathresh <- read.csv("./output/sample-MLS_type-session_stats-est_mask-wilson-supra.tsv", sep = '\t')
mls_icc_suprathresh$study <- "mls"
mls_icc_suprathresh <- update_mls_fwhm(mls_icc_suprathresh)

mls_icc_nacc <- read.csv("./output/sample-MLS_type-run_stats-est_mask-nacc.tsv", sep = '\t')
mls_icc_nacc$study <- "mls"
mls_icc_nacc <- update_mls_fwhm(mls_icc_nacc)

# MSBS
mls_bs_subthresh <- read.csv("./output/sample-MLS_type-session_stats-bs_mask-wilson-sub.tsv", sep = '\t')
mls_bs_subthresh$study <- "mls"
mls_bs_subthresh <- update_mls_fwhm(mls_bs_subthresh)

mls_bs_suprathresh <- read.csv("./output/sample-MLS_type-session_stats-bs_mask-wilson-supra.tsv", sep = '\t')
mls_bs_suprathresh$study <- "mls"
mls_bs_suprathresh <- update_mls_fwhm(mls_bs_suprathresh)

# MSWS
mls_ws_subthresh <- read.csv("./output/sample-MLS_type-session_stats-ws_mask-wilson-sub.tsv", sep = '\t')
mls_ws_subthresh$study <- "mls"
mls_ws_subthresh <- update_mls_fwhm(mls_ws_subthresh)

mls_ws_suprathresh <- read.csv("./output/sample-MLS_type-session_stats-ws_mask-wilson-supra.tsv", sep = '\t')
mls_ws_suprathresh$study <- "mls"
mls_ws_suprathresh <- update_mls_fwhm(mls_ws_suprathresh)

# similarity
mls_similarity <- read.csv("./output/sample-MLS_type-session_stats-similarity.tsv", sep = '\t')
mls_similarity$study <- "mls"
mls_similarity <- mls_similarity %>%
    mutate(fwhm = case_when(
      fwhm == 3 ~ 3.6,
      fwhm == 4 ~ 4.8,
      fwhm == 5 ~ 6.0,
      fwhm == 6 ~ 7.2,
      fwhm == 7 ~ 8.4,
      TRUE ~ fwhm)  # if none of the conditions match, keep the original value
    )

```

## combine data

```{r message=FALSE, warning=FALSE, include=FALSE}
# ICC
icc_subthresh <- rbind(abcd_icc_subthresh, ahrb_icc_subthresh, mls_icc_subthresh)
icc_subthresh <- icc_subthresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

icc_suprathresh <- rbind(abcd_icc_suprathresh, ahrb_icc_suprathresh, mls_icc_suprathresh)
icc_suprathresh <-  icc_suprathresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

icc_nacc <- rbind(abcd_icc_nacc, ahrb_icc_nacc, mls_icc_nacc)
icc_nacc <-  icc_nacc %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

# MSBS
bs_subthresh <- rbind(abcd_bs_subthresh, ahrb_bs_subthresh, mls_bs_subthresh)
bs_subthresh <- bs_subthresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))
bs_suprathresh <- rbind(abcd_bs_suprathresh, ahrb_bs_suprathresh, mls_bs_suprathresh)
bs_suprathresh <-  bs_suprathresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

# MSWS
ws_subthresh <- rbind(abcd_ws_subthresh, ahrb_ws_subthresh, mls_ws_subthresh)
ws_subthresh <- ws_subthresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))
ws_suprathresh <- rbind(abcd_ws_suprathresh, ahrb_ws_suprathresh, mls_ws_suprathresh)
ws_suprathresh <-  ws_suprathresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

# similarity
similarity_df <- rbind(ahrb_similarity, mls_similarity, abcd_similarity)
similarity_df <-  similarity_df %>% 
  mutate(con = gsub("-", "", con))
similarity_df$fwhm <- as.character(similarity_df$fwhm)


# remove excess files
rm(ahrb_bs_subthresh, ahrb_bs_suprathresh, ahrb_icc_subthresh, ahrb_icc_suprathresh, ahrb_ws_subthresh, ahrb_ws_suprathresh,ahrb_similarity,
   abcd_bs_subthresh, abcd_bs_suprathresh, abcd_icc_subthresh, abcd_icc_suprathresh, abcd_ws_subthresh, abcd_ws_suprathresh,abcd_similarity,
   mls_bs_subthresh, mls_bs_suprathresh, mls_icc_subthresh, mls_icc_suprathresh, mls_ws_subthresh, mls_ws_suprathresh,mls_similarity, abcd_icc_nacc, mls_icc_nacc, ahrb_icc_nacc)
```


# Sample descriptives {.tabset}

## ABCD
```{r}
# ABCD NDA DATA Info
abcd_nda$subject <- abcd_nda$participant_id
abcd_nda$subject <- gsub("_", "", abcd_nda$subject)
abcd_nda$session <- abcd_nda$eventname
abcd_nda$session <- gsub('2_year_follow_up_y_arm_1', '2YearFollowUpYArm1', abcd_nda$session)
abcd_nda$session <- gsub('baseline_year_1_arm_1', 'baselineYear1Arm1', abcd_nda$session)

# subsat subjects that match final QC'd listed
abcd_nda_subset <- abcd_nda %>% 
  filter(subject %in% abcd_site13_ids$V1) %>% 
  select(!c(subjectkey,eventname))

abcd_beh$subject <- gsub("sub-", "", abcd_beh$subject)
abcd_beh_r <- abcd_beh %>% 
  filter(subject %in% abcd_site13_ids$V1)
abcd_beh_r$sample <- "ABCD"

# estimate days
abcd_days <- abcd_nda_subset %>% 
  mutate(date_r = as.Date(interview_date, format = "%m/%d/%Y")) %>% 
  group_by(subject) %>% 
  arrange(date_r) %>% 
  mutate(days_btwn_scans =  as.integer(diff(date_r))) %>% 
  select(days_btwn_scans, subject, interview_age,sex, race_ethnicity) 

colnames(abcd_days) <- c("days","subject","Age","Sex","Race")
abcd_days$sample <- "ABCD"

abcd_days <- abcd_days %>% 
  mutate(Race = case_when(
      Race == 1 ~ "White",
      Race == 2 ~ "Black",
      Race == 3 ~ "Hispanic",
      Race == 4 ~ "Asian",
      Race == 5 ~ "Other",
      TRUE ~ as.character(Race)  # if none of the conditions match, keep the original value
    ))

rm(abcd_nda,abcd_site13_ids,abcd_beh)
```

## AHRB
```{r}
ahrb_beh_r <- ahrb_beh %>% 
  filter(subject %in% ahrb_ids$V1)
ahrb_beh_r$sample <- "AHRB"

ahrb_demo_subset <- ahrb_demo %>% 
  filter(participant_id %in% ahrb_ids$V1) %>% 
  mutate(days = days_ses1toses2)
ahrb_demo_subset$sample <- "AHRB"

ahrb_demo_subset <- ahrb_demo_subset %>% 
  mutate(Race = case_when(
      race == 1 ~ "White",
      race == 2 ~ "Black",
      race == 3 ~ "Hispanic",
      race == 4 ~ "Other",
      TRUE ~ as.character(race)  # if none of the conditions match, keep the original value
    ))

rm(ahrb_demo, ahrb_ids,ahrb_beh)
```

## mls
```{r}
mls_beh_r <- mls_beh %>% 
  filter(subject %in% mls_ids$V1)
mls_beh_r$sample <- "MLS"

mls_demo_subset <- mls_demo %>% 
  filter(participant_id %in% mls_ids$V1) %>% 
  mutate(days = if_else(is.na(reward_days_ses1toses2),
                        reward_ses2toses3,reward_days_ses1toses2)
  ) %>% 
  filter(session==1) %>% 
  rename()
mls_demo_subset$sample <- "MLS"
mls_demo_subset <- mls_demo_subset %>% 
  mutate(Race = case_when(
      Race == 1 ~ "White",
      Race == 2 ~ "Black",
      Race == 13 ~ "Hispanic",
      TRUE ~ "Other"  # if none of the conditions match, keep the original value
    ))

rm(mls_demo, mls_ids, mls_beh)

```

```{r}
dur_scans <- rbind(abcd_days %>% select(subject,days,sample) %>% unique(),
                   ahrb_demo_subset %>% rename("subject" = participant_id) %>% select(subject,days,sample),
                   mls_demo_subset %>% rename("subject" = participant_id) %>% select(subject,days,sample))
```



## Days ses-to-ses

Plot distribution of days between scans
```{r fig.height=4, fig.width=14}
dur_scans %>% 
  ggplot(aes(x = subject, y = days, fill = sample, color="white")) +
  geom_bar(stat = 'identity', position = 'dodge') +
  ylab("Days between scans") +
  xlab("") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = "white") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), text = element_text(family = "Times New Roman")) +
  facet_grid(~sample, scales = 'free_x') +
  guides(fill = FALSE, color = FALSE, scale = "none")

dur_scans %>%
    group_by(sample) %>% 
    summarise(
      "Sample (N)" = n(),
      "Avg Days Between Scans" = mean(days),
      "SD Days Between Scans" = sd(days)
    ) %>% 
  kbl(format = "html", 
      booktabs = TRUE) %>% 
  kable_styling(full_width = FALSE)
```

## demographics

```{r}
demo_comb <- rbind(abcd_days %>% distinct(subject, .keep_all = TRUE) %>% 
                     mutate(sample = "ABCD", Age = round(Age/12,2)) %>% 
                     select(sample, subject,Age, Sex, Race, days),
                   ahrb_demo_subset %>% 
                     mutate(sample = "AHRB", Sex = if_else(sex==0,"F","M")) %>% 
                     rename("Age"= age, "subject" = participant_id) %>% 
                     select(sample, subject,Age, Sex, Race, days),
                   mls_demo_subset %>% 
                     mutate(sample = "MLS", Age = round(if_else(is.na(reward_days_ses1toses2),
                                                                ((ScanAge * 365) + reward_ses2toses3) / 365,
                                                                ScanAge),1),
                            Sex = if_else(Sex==1,"F","M")) %>% 
                     rename("subject" = participant_id) %>% 
                     select(sample, subject,Age,Sex, Race, days) 
                   ) 


table1(~Age + factor(Sex) + factor(Race) + days | sample, data = demo_comb)
```

## behavioral descriptives

```{r}
beh_dat <- rbind(abcd_beh_r,ahrb_beh_r,mls_beh_r) %>% 
   mutate(session = gsub("baselineYear1Arm1", 1, session), session = gsub("2YearFollowUpYArm1", 2, session))
rm(abcd_beh_r,ahrb_beh_r,mls_beh_r)
```

```{r}
beh_dat <- beh_dat %>% 
  mutate(mFD = (mFD_r1+mFD_r2)/2,
         avg_acc = (acc_r1+acc_r2)/2,
         avg_mrt = (mrt_r1+mrt_r2)/2)

# mean/sd, min, max
calculate_summary_stats(beh_dat %>% rename("study" = sample) %>% filter(session=="1"), mFD, "Ses-1: Mean FD")
calculate_summary_stats(beh_dat %>% rename("study" = sample) %>% filter(session=="2"), mFD, "Ses-2: Mean FD")
calculate_summary_stats(beh_dat %>% rename("study" = sample) %>% filter(session=="1"), avg_acc, 
                        "Ses-1: Avg Probe Acc %")
calculate_summary_stats(beh_dat %>% rename("study" = sample) %>% filter(session=="2"), avg_acc, 
                        "Ses-1: Avg Probe Acc %")
calculate_summary_stats(beh_dat %>% rename("study" = sample) %>% filter(session=="1"), avg_mrt, 
                        "Ses-1: Avg Probe MRT (ms)")
calculate_summary_stats(beh_dat %>% rename("study" = sample) %>% filter(session=="2"), avg_mrt, 
                        "Ses-2: Avg Probe MRT (ms)")
```

```{r message=FALSE, warning=FALSE, fig.height=6, fig.width=9}
acc_plt <- beh_dat %>% 
  ggplot(aes(x = sample, y = avg_acc, fill = sample, color = sample)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.1
            )) +
  facet_grid(~session) +
  theme_classic() +
  labs(#title = paste("Distribution of Probe Accuracy (%) Across Sample and Sessions"),
          x = "Sample", y = "Probe Acc (%)") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))

mrt_plt <- beh_dat %>% 
  ggplot(aes(x = sample, y = avg_mrt, fill = sample, color = sample)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.1
            )) +
  facet_grid(~session) +
  theme_classic() +
  labs(#title = "Distribution of Probe Mean RT (ms) Across Sample and Sessions",
          x = "Sample", y = "MRT (ms)") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))

mfd_plt <- beh_dat %>% 
  ggplot(aes(x = sample, y = mFD, fill = sample, color = sample)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.1
            )) +
  facet_grid(~session) +
  theme_classic() +
  labs(#title = "Distribution of mean Framewise-displace (mFD) Across Sample and Sessions",
          x = "Sample", y = "mFD") +
  ylim(0,1) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))

cat("Plotting A = Avg Acc; B = Avg MRT; C = MeanFD ")
(acc_plt | mrt_plt | mfd_plt) + plot_annotation(tag_levels = c("A","B","C")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
```

# Plot distributions {.tabset}

Below, running the steps to summarize the different Intraclass correlation (ICC), Mean Squared Between Subject (MSBS), Mean Square Within Subject (MSWS), and jaccard and spearman similarty for the model combinations `r 5*6*3*4` across samples

## ICC

Plotting overall and for each of [four] categories

### Subthreshold Mask

Creating rainclouds via [ggrain](https://cran.r-project.org/web/packages/ggrain/vignettes/ggrain.html)

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(icc_subthresh, y_est = "median_est", y_min =-.1, y_max=.6, y_lab = "Median ICC")
fwhm_rg = create_plot(icc_subthresh, y_est = "median_est", type = "fwhm",  thresh = "sub-threshold", 
                      y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
motion_rg = create_plot(icc_subthresh, y_est = "median_est", type = "motion", thresh = "sub-threshold", 
                        y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
modeltype_rg = create_plot(icc_subthresh, y_est = "median_est", type = "model", thresh = "sub-threshold",
                           y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
contrast_rg = create_plot(icc_subthresh, y_est = "median_est", type = "con", thresh = "sub-threshold", 
                          y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for sub-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```


### Suprathreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(icc_suprathresh, y_est = "median_est", y_min=-.1, y_max=.6, y_lab = "Median ICC")
fwhm_rg = create_plot(icc_suprathresh, y_est = "median_est", type = "fwhm",  thresh = "supra-threshold", 
                      y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
motion_rg = create_plot(icc_suprathresh, y_est = "median_est", type = "motion", thresh = "supra-threshold", 
                        y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
modeltype_rg = create_plot(icc_suprathresh, y_est = "median_est", type = "model", thresh = "supra-threshold",
                           y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
contrast_rg = create_plot(icc_suprathresh, y_est = "median_est", type = "con", thresh = "supra-threshold", 
                          y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)


cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for supra-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

### Nacc avg Mask

#### Right

```{r, fig.width=16, fig.height=10}
fwhm_rg = create_plot(icc_nacc, y_est = "avg_right", "fwhm","Avg Right NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
motion_rg = create_plot(icc_nacc, y_est = "avg_right", "motion","Avg Right NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
modeltype_rg = create_plot(icc_nacc, y_est = "avg_right", "model","Avg Right NAcc",y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
contrast_rg = create_plot(icc_nacc, y_est = "avg_right", "con","sAvg Right NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for Right NAcc")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
```


#### Left 

```{r, fig.width=16, fig.height=10}
fwhm_rg = create_plot(icc_nacc, y_est = "avg_left", "fwhm","Avg Left NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
motion_rg = create_plot(icc_nacc, y_est = "avg_left", "motion","Avg Left NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
modeltype_rg = create_plot(icc_nacc, y_est = "avg_left", "model","Avg Left NAcc",y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
contrast_rg = create_plot(icc_nacc, y_est = "avg_left", "con","sAvg Left NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for Left NAcc")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
```


## MSBS

Plotting overall and for each of [four] categories

### Subthreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(bs_subthresh, y_est = "median_est", y_min=0, y_max=7, y_lab = "Median MSBS")
fwhm_rg = create_plot(bs_subthresh, y_est = "median_est", type = "fwhm",  thresh = "sub-threshold", 
                      y_min=0, y_max=7, y_lab = "Median MSBS", add_title=FALSE)
motion_rg = create_plot(bs_subthresh, y_est = "median_est", type = "motion", thresh = "sub-threshold", 
                        y_min=0, y_max=7, y_lab = "Median MSBS", add_title=FALSE)
modeltype_rg = create_plot(bs_subthresh, y_est = "median_est", type = "model", thresh = "sub-threshold",
                           y_min=0, y_max=7, y_lab = "Median MSBS", add_title=FALSE)
contrast_rg = create_plot(bs_subthresh, y_est = "median_est", type = "con", thresh = "sub-threshold", 
                          y_min=0, y_max=7, y_lab = "Median MSBS", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for sub-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

### Suprathreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(bs_suprathresh, y_est = "median_est", y_min=0, y_max=7, y_lab = "Median MSBS")
fwhm_rg = create_plot(bs_suprathresh, y_est = "median_est", type = "fwhm",  thresh = "supra-threshold", 
                      y_min=0, y_max=7, y_lab = "Median MSBS", add_title=FALSE)
motion_rg = create_plot(bs_suprathresh, y_est = "median_est", type = "motion", thresh = "supra-threshold", 
                        y_min=0, y_max=7, y_lab = "Median MSBS", add_title=FALSE)
modeltype_rg = create_plot(bs_suprathresh, y_est = "median_est", type = "model", thresh = "supra-threshold",
                           y_min=0, y_max=7, y_lab = "Median MSBS", add_title=FALSE)
contrast_rg = create_plot(bs_suprathresh, y_est = "median_est", type = "con", thresh = "supra-threshold", 
                          y_min=0, y_max=7, y_lab = "Median MSBS", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for supra-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```


## MSWS

Plotting overall and for each of [four] categories

### Subthreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(ws_subthresh, y_est = "median_est", y_min=0, y_max=7, y_lab = "Median MSWS")
fwhm_rg = create_plot(ws_subthresh, y_est = "median_est", type = "fwhm",  thresh = "sub-threshold", 
                      y_min=0, y_max=7, y_lab = "Median MSWS", add_title=FALSE)
motion_rg = create_plot(ws_subthresh, y_est = "median_est", type = "motion", thresh = "sub-threshold", 
                        y_min=0, y_max=7, y_lab = "Median MSWS", add_title=FALSE)
modeltype_rg = create_plot(ws_subthresh, y_est = "median_est", type = "model", thresh = "sub-threshold",
                           y_min=0, y_max=7, y_lab = "Median MSWS", add_title=FALSE)
contrast_rg = create_plot(ws_subthresh, y_est = "median_est", type = "con", thresh = "sub-threshold", 
                          y_min=0, y_max=7, y_lab = "Median MSWS", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for sub-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

### Suprathreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(ws_suprathresh, y_est = "median_est", y_min=0, y_max=7, y_lab = "Median MSWS")
fwhm_rg = create_plot(ws_suprathresh, y_est = "median_est", type = "fwhm",  thresh = "supra-threshold", 
                      y_min=0, y_max=7, y_lab = "Median MSWS", add_title=FALSE)
motion_rg = create_plot(ws_suprathresh, y_est = "median_est", type = "motion", thresh = "supra-threshold", 
                        y_min=0, y_max=7, y_lab = "Median MSWS", add_title=FALSE)
modeltype_rg = create_plot(ws_suprathresh, y_est = "median_est", type = "model", thresh = "supra-threshold",
                           y_min=0, y_max=7, y_lab = "Median MSWS", add_title=FALSE)
contrast_rg = create_plot(ws_suprathresh, y_est = "median_est", type = "con", thresh = "supra-threshold", 
                          y_min=0, y_max=7, y_lab = "Median MSWS", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for supra-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```


## Similarity

### jaccard

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(similarity_df, y_est = "jaccard", y_min=0, y_max = 1, y_lab = "Jaccard")

fwhm_rg = create_plot(similarity_df, y_est = "jaccard", type = "fwhm", thresh = "Jaccard", 
                      y_min=0, y_max = 1, y_lab = "Jaccard", add_title=FALSE)
motion_rg = create_plot(similarity_df, y_est = "jaccard", type = "motion", thresh = "Jaccard", 
                        y_min=0, y_max = 1, y_lab = "Jaccard", add_title=FALSE)
modeltype_rg = create_plot(similarity_df, y_est = "jaccard", type = "model", thresh="Jaccrd", 
                           y_min=0, y_max = 1, y_lab = "Jaccard", add_title=FALSE)
contrast_rg = create_plot(similarity_df, y_est = "jaccard", type = "con", thresh = "Jaccard", 
                          y_min=0, y_max = 1, y_lab = "Jaccard", add_title=FALSE)


cat("Jaccard: Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset

```

### spearman

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(similarity_df, y_est = "spearman", y_min=0, y_max = 1, y_lab = "Spearman")

fwhm_rg = create_plot(similarity_df, y_est = "spearman", type = "fwhm", thresh = "Spearman", 
                      y_min=0, y_max = 1, y_lab = "Spearman", add_title=FALSE)
motion_rg = create_plot(similarity_df, y_est = "spearman", type = "motion", thresh = "Spearman", 
                        y_min=0, y_max = 1, y_lab = "Spearman", add_title=FALSE)
modeltype_rg = create_plot(similarity_df, y_est = "spearman", type = "model", thresh="Spearman", 
                           y_min=0, y_max = 1, y_lab = "Spearman", add_title=FALSE)
contrast_rg = create_plot(similarity_df, y_est = "spearman", type = "con", thresh = "Spearman", 
                          y_min=0, y_max = 1, y_lab = "Spearman", add_title=FALSE)

cat("Spearman: Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

## Group Cohen's ~ ICC 

```{r}
cohens_sim <- gather(similarity_df, key = "Ses", value = "spearman", ses1_icc_cohensd:ses2_icc_cohensd) %>% 
  mutate(Run = case_when(
    Ses == "ses1_icc_cohensd" ~ "ses1",
    Ses == "ses_icc_cohensd" ~ "ses2",
    TRUE ~ Ses
  ))
```

```{r, fig.width=16, fig.height=10}
cat("\tICC, MSBS and MSWS median, miniumum and maximum")
calculate_summary_stats(similarity_df, ses1_icc_cohensd, "ICC ~ Ses1 Cohen's D")
calculate_summary_stats(similarity_df, ses2_icc_cohensd, "ICC ~ Ses2 Cohen's D")
```

```{r}
cohens_sim %>% ggplot(aes(x = fwhm, y = spearman, fill = fwhm, color = fwhm)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .2), width = 0.1
            )) +
  facet_grid(~study + Ses) +
  theme_classic() +
  ggtitle("Distribution by FWHM category") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))

cohens_sim %>% ggplot(aes(x = con, y = spearman, fill = con, color = con)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .2), width = 0.1
            )) +
  facet_grid(~study + Ses) +
  theme_classic() +
  ggtitle("Distribution by Contrast category") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))


cohens_sim %>% ggplot(aes(x = motion, y = spearman, fill = motion, color = motion)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .2), width = 0.1
            )) +
  facet_grid(~study + Ses) +
  theme_classic() +
  ggtitle("Distribution by Motion category") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))

cohens_sim %>% ggplot(aes(x = model, y = spearman, fill = model, color = model)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .2), width = 0.1
            )) +
  facet_grid(~study + Ses) +
  theme_classic() +
  ggtitle("Distribution by Model category") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))
```



# Med/Min/Max Across Models {.tabset}

## Subtreshold

```{r}
cat("Subthreshold mask")
cat("\tICC, MSBS and MSWS median, miniumum and maximum")
calculate_summary_stats(icc_subthresh, median_est, "ICC")
calculate_summary_stats(bs_subthresh, median_est, "MSBS")
calculate_summary_stats(ws_subthresh, median_est, "MSWS")
```

## Suprathreshold
```{r message=FALSE, warning=FALSE}
cat("Suprathreshold mask")
cat("\tICC, MSBS and MSWS median, miniumum and maximum")
calculate_summary_stats(icc_suprathresh, median_est, "ICC")
calculate_summary_stats(bs_suprathresh, median_est, "MSBS")
calculate_summary_stats(ws_suprathresh, median_est, "MSWS")
```

## simlarity

```{r}
cat("Similarity median, minimum and maximum for jaccard and spearman")
calculate_summary_stats(similarity_df, jaccard, "Jaccard")
calculate_summary_stats(similarity_df, spearman, "Spearman")
```


# Specification Curve {.tabset}

Creating data in a format that is compatible with [specr](https://cran.r-project.org/web/packages/specr/specr.pdf). Needs: estimate (i.e., ICC), std.error, conf.high, conf.low.


## ICC


### suprathreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
# first, combine independent model vars into string to create average for each model type
icc_suprathresh$model_type <- paste(icc_suprathresh$fwhm, icc_suprathresh$motion,
                                    icc_suprathresh$con,  icc_suprathresh$model,
                                    sep = "_")

# calculate the avg estimate of ICC across study, standard error and +/- 95% confidence interval. In complete version
df_summ <- icc_suprathresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "supra-threshod ICC"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "supra-threshold ICC"
create_specr_plot(df_summ_subset, est_label)
```

### subthreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
icc_subthresh$model_type <- paste(icc_subthresh$fwhm, icc_subthresh$motion,
                                  icc_subthresh$con,  icc_subthresh$model,
                                  sep = "_")

df_summ <- icc_subthresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "sub-threshold ICC"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "sub-threshold ICC"
create_specr_plot(df_summ_subset, est_label)
```


## MSBS

### suprathreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
bs_suprathresh$model_type <- paste(bs_suprathresh$fwhm, bs_suprathresh$motion,
                                   bs_suprathresh$con,  bs_suprathresh$model,
                                   sep = "_")

df_summ <- bs_suprathresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "supra-threshold MSBS"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "supra-threshold MSBS"
create_specr_plot(df_summ_subset, est_label)
```

### subthreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
bs_subthresh$model_type <- paste(bs_subthresh$fwhm, bs_subthresh$motion,
                                 bs_subthresh$con,  bs_subthresh$model,
                                 sep = "_")


df_summ <- bs_subthresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "sub-threshold MSBS"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "suprathreshold MSBS"
create_specr_plot(df_summ_subset, est_label)
```


## MSWS

### suprathreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
ws_suprathresh$model_type <- paste(ws_suprathresh$fwhm, ws_suprathresh$motion,
                                   bs_suprathresh$con,  ws_suprathresh$model,
                                   sep = "_")

df_summ <- ws_suprathresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "supra-threshold MSWS"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "supra-threshold MSWS"
create_specr_plot(df_summ_subset, est_label)
```

### subthreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
ws_subthresh$model_type <- paste(ws_subthresh$fwhm, ws_subthresh$motion,
                                 ws_subthresh$con,  ws_subthresh$model,
                                 sep = "_")

# calculate the avg estimate of ICC across study, standard error and +/- 95% confidence interval. In complete version
df_summ <- ws_subthresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "sub-threshold MSWS"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subplot
est_label = "sub-threshold MSWS"
create_specr_plot(df_summ_subset, est_label)
```

## Similarity

### Jaccard 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r warning=FALSE}
similarity_df$model_type <- paste(similarity_df$fwhm, similarity_df$motion,
                                  similarity_df$con, similarity_df$model,
                                  sep = "_")

df_summ <- similarity_df %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(jaccard), std.error = sd(jaccard)/sqrt(length(jaccard))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "Jaccard"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "Jaccard"
create_specr_plot(df_summ_subset, est_label)
```

### Spearman 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r warning=FALSE}
similarity_df$model_type <- paste(similarity_df$fwhm, similarity_df$motion,
                                  similarity_df$con,  similarity_df$model, 
                                  sep = "_")

# calculate the avg estimate of ICC across study, standard error and +/- 95% confidence interval. In complete version
df_summ <- similarity_df %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(spearman), std.error = sd(spearman)/sqrt(length(spearman))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "Spearman"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "Spearman"
create_specr_plot(df_summ_subset, est_label)
```