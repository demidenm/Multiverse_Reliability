#!/bin/bash

# define variables
curr_dir=`pwd`
ses=SESSION
task=MID
model=MODEL
# wilson-sub, wilson-supra
mask_label=MASKLABEL
# session or run
type=TYPE
inp_fold=INPFOLD
subj_ids=SUBJ_IDS
script_dir=${curr_dir}/..

if [[ $mask_label == "wilson-sub" || $mask_label == "wilson-supra" ]]; then
	echo "Setting mask label"
	Mas
	mask_path=${curr_dir}/../brain_mask/MNI152_${mask_label}.nii.gz
	out_fold=/scratch.global/${USER}/analyses_reliability/icc_mods/${type}/${mask_label}
else
	echo "No mask being used, set to None"
	mask_path=None
	out_fold=/scratch.global/${USER}/analyses_reliability/icc_mods/${type}
fi

# move subjects from list to temp
dat_in="${inp_fold/\/scratch.local\///scratch.global/}"

if [ ${type} == 'session' ]; then
	cat ${subj_ids} | while read subj ; do
		sub=$(echo $subj | awk -F" " '{ print $1}' )
        	for sess in baselineYear1Arm1 2YearFollowUpYArm1 ; do
                	mkdir -p ${inp_fold}/ses-${sess}/${sub}
                	cp ${dat_in}/ses-${sess}/${sub}/*${model}* ${inp_fold}/ses-${sess}/${sub}/
        	done
	done
elif [ ${type} == 'run' ]; then
	cat ${subj_ids} | while read subj ; do
        	sub=$(echo $subj | awk -F" " '{ print $1}' )
       		for sess in ${ses} ; do
                	mkdir -p ${inp_fold}/ses-${sess}/${sub}
                	cp ${dat_in}/ses-${sess}/${sub}/*${model}* ${inp_fold}/ses-${sess}/${sub}/
        	done
	done
else
                echo "Invalid type: $type"
fi

echo "#### Starting ICC estimation ####" 

# Define directories

[ ! -d ${out_fold} ] && echo "ICC folder out directory exists" | mkdir -p ${out_fold} 

# run python script
echo "sub: ${sub}"
echo "model: ${model}"
echo "Inp: ${inp_fold}"
echo "Out: ${out_fold}"

if [[ $mask_label == "None" ]]; then
	python ${script_dir}/compute_icc_permutations.py --sample abcd --task ${task} --ses ${ses} --type ${type} --model ${model} --inp_path ${inp_fold} --output ${out_fold}
	icc_error=$?
else
	python ${script_dir}/compute_icc_permutations.py --sample abcd --task ${task} --ses ${ses} --type ${type} --model ${model} --mask ${mask_path} --mask_label ${mask_label} --inp_path ${inp_fold} --output ${out_fold}
	icc_error=$?
fi

if [ ${icc_error} -eq 0 ]; then
        echo "Python ICC permutation ${model} completed successfully!"
else
        echo "Python ICC permutation ${model} failed."
        exit 1
fi
