---
title: "Descriptives - Run Models"
author: "<h3>by Michael Demidenko</h3>"
date: "`r format(Sys.time(), '%B %Y')`"
output:
  html_document:
    theme: united
    highlight: tango
    toc: yes
    number_sections: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    code_folding: hide
    self_contained: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
tags: []
subtitle: <h2><u>Reliability, fMRI, tasks </u></h2>
---


```{r message=FALSE, warning=FALSE, include=FALSE}
if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse, ggplot2, knitr, kableExtra, ggpubr, lme4, sjPlot, specr, ggrain, neuRosim, emmeans, zoo, stringr, patchwork)

pal<- c("#1D91C0","#67001F","#CB181D","#78C679","#F46D43","#A6CEE3",
        "#F7FCFD","#FD8D3C","#A6D854","#D4B9DA","#6A51A3",
        "#7F0000","#D9D9D9","#FFF7BC","#000000","#F0F0F0",
        "#C7EAE5","#003C30","#F16913","#FFF7FB","#8C6BB1",
        "#C7E9B4","#762A83","#FC9272","#DF65B0","#EF3B2C",
        "#74C476","#E5F5F9","#AE017E","#F7F7F7")


session_info = sessionInfo()
system=session_info[[1]][1]
R_vers = session_info[[1]][13]
```

Plotting function to reduce code length + simplify. Then, short function to place MLS weight smoothing kernel into same category to make visually consistent, updates are:

- 3.0 --> 3.6
- 4.0 --> 4.8
- 5.0 --> 6.0
- 6.0 --> 7.2
- 7.0 --> 8.4

```{r}
create_plot <- function(dataset, y_est, type, thresh, y_min, y_max, y_lab, add_title = TRUE) {
  plot <- dataset %>%
    ggplot(aes(x = .data[[type]], y = .data[[y_est]], fill = .data[[type]], color = .data[[type]])) +
    geom_rain(alpha = .5, rain.side = 'l',
              boxplot.args = list(color = "black", outlier.shape = NA),
              boxplot.args.pos = list(
                position = ggpp::position_dodgenudge(x = .1), width = 0.1
              )) +
    facet_grid(~study) +
    ylab(y_lab) +
    ylim(y_min,y_max)+
    theme_classic() 
  
  if (add_title) {
    plot <- plot + ggtitle(paste("Distribution by", type, "category (", thresh, "mask)"))
  }
  
  plot <- plot +
    scale_fill_manual(values = pal) +
    scale_color_manual(values = pal) +
    guides(fill = 'none', color = 'none') +
    theme(text = element_text(family = "Times New Roman"),
          axis.text = element_text(size = 12, angle = 45, hjust = 1),
          axis.title = element_text(size = 12),
          legend.text = element_text(size = 12),
          legend.title = element_text(size = 12),
          plot.title = element_text(size = 16))
}

by_sample_conmod <- function(dataset, y_est, y_min, y_max, y_lab) {
  
  # Define a function to create individual plots
  create_plot <- function(data, study) {
    ggplot(data, aes(x = con, y = .data[[y_est]], fill = con, color = con)) +
      geom_rain(alpha = .5, rain.side = 'l',
                boxplot.args = list(color = "black", outlier.shape = NA),
                boxplot.args.pos = list(
                  position = ggpp::position_dodgenudge(x = .1), width = 0.1
                )) +
      facet_grid(~model) +
      ylab(y_lab) +
      ylim(y_min,y_max)+
      theme_classic() +
      scale_fill_manual(values = pal) +
      scale_color_manual(values = pal) +
      guides(fill = 'none', color = 'none') +
      theme(text = element_text(family = "Times New Roman"),
            axis.text = element_text(size = 12, angle = 45, hjust = 1),
            axis.title = element_text(size = 12),
            legend.text = element_text(size = 12),
            legend.title = element_text(size = 12),
            plot.title = element_text(size = 16)) +
      ggtitle(study) 
  }
  
  # Create plots for each study using map
  plot_list <- purrr::map(c("mls", "ahrb", "abcd"), ~ dataset %>%
                            filter(study == .x) %>%
                            create_plot(.x))
  
  # Combine plots into a single patchwork object
  combined_plots <- wrap_plots(plotlist = plot_list)
  
  # Add patchwork annotations
  combined_plots 
}

update_mls_fwhm <- function(df) {
  df <- df %>%
    mutate(fwhm = case_when(
      fwhm == "fwhm-3.0" ~ "fwhm-3.6",
      fwhm == "fwhm-4.0" ~ "fwhm-4.8",
      fwhm == "fwhm-5.0" ~ "fwhm-6.0",
      fwhm == "fwhm-6.0" ~ "fwhm-7.2",
      fwhm == "fwhm-7.0" ~ "fwhm-8.4",
      TRUE ~ as.character(fwhm)  # if none of the conditions match, keep the original value
    ))
  return(df)
}

create_specr_plot <- function(summary_df, est_label) {
  plot_a = plot_curve(df = summary_df, ci = TRUE, desc = FALSE, legend = FALSE, null = 0)
  plot_b <- plot_choices(df = summary_df, choices = c("fwhm", "motion","contrast","model"), desc = F, null = 0) +
    labs(y = "Variables", x = paste("Ordered Specification Curve \n",est_label, "coefficient"))
  
  cowplot::plot_grid(plot_a, plot_b, ncol = 1, align = "v", axis = 'tblr',
                     labels = c('A', 'B'), rel_heights = c(1, 2),
                     label_fontfamily = "Times", label_size = 12)
}

calculate_summary_stats <- function(data, variable, est_type) {
  data %>%
    select(study, {{variable}}) %>% 
    group_by(study) %>% 
    summarise(
      "est_type" = est_type,
      "median" = median({{variable}}, na.rm = TRUE),
      "mean" = mean({{variable}}, na.rm = TRUE),
      "sd" = sd({{variable}}, na.rm = TRUE),
      "min" = min({{variable}}, na.rm = TRUE),
      "max" = max({{variable}}, na.rm = TRUE) 
    ) %>% 
  kbl(format = "html", 
      booktabs = TRUE) %>% 
  kable_styling(full_width = FALSE)
  
}
```

The packages are automatically loaded using `pacman`. The reported .html was last ran on the system: `r system` and R version: `r R_vers`
***
***
In the Stage 1 [PCI Registered Report](https://doi.org/10.17605/OSF.IO/NQGEH) we are focused on Individual Continouous (intraclass correlation) and the binary/continuous group similarity (jaccard and spearman). This descriptive file includes the output information for the distribution plots, min/max/mean/median of the estimates and the spec plots for each estimate time. This report is for the *Session1 between-run* estimates

**continuous**

We stated:

Aim1: *the range and distribution of median ICCs across each study (three) and analytic decision category (four) are plotted across suprathreshold task-positive and subthreshold ICCs using Rainclouds (Allen et al., 2019) and the median and standard deviation is reported in a table.*

*to visualize the ordered median ICCs across the 360 model permutations for suprathreshold task-positive and subthreshold ICCs, specification curve analyses are used (Simonsohn et al., 2020). Specifically, results across the 360 model permutations are reported using a specification curve to represent the range of estimated effects across the variable permutations. This consists of two panels: Panel A represents the ordered ICC coefficients and the ICC’s associated 95% confidence interval colored based on no significance (gray), negative (red) or positive (blue) significance from the Null (Null here is 0) and Panel B represents the analytic decisions from each of the four categories (see Table 1) that produced the median ICC estimates. In the main text, to compare the highest and lowest ICC’s produced by the model permutations, the 25th percentile and 75th percentile median ICC estimates from the 360 models are reported separately for suprathreshold task-positive and subthreshold activation (the specification curve for all ICC estimates for suprathreshold task-positive and subthreshold activation are provided as supplemental information).*

Aim2: *the range and distribution of median Between Subject and Within Subject across each study and analytic decision category are plotted across suprathreshold task-positive and subthreshold ICCs using Rainclouds.*

*two separate specification curve analyses report the ordered median Between Subject and Within Subject coefficients in one panel and the analytic decisions that produced the Between Subject and Within Subject estimates in a second panel separately for suprathreshold task-positive and subthreshold activation*

**group similarity**

We stated:

Aim1: *For each study, the coefficients are plotted to reflect the distribution and range of coefficients. Both Jaccard’s and Spearman correlation are reported separately.*

***
***

# Load data {.tabset}

## ABCD
```{r include=FALSE}
# ICC
abcd_icc_subthresh <- read.csv("./output/sample-abcd_type-run_stats-est_mask-wilson-sub.tsv", sep = '\t')
abcd_icc_subthresh$study <- "abcd"
abcd_icc_suprathresh <- read.csv("./output/sample-abcd_type-run_stats-est_mask-wilson-supra.tsv", sep = '\t')
abcd_icc_suprathresh$study <- "abcd"
abcd_icc_nacc <- read.csv("./output/sample-abcd_type-run_stats-est_mask-nacc.tsv", sep = '\t')
abcd_icc_nacc$study <- "abcd"

# Between Subject
abcd_bs_subthresh <- read.csv("./output/sample-abcd_type-run_stats-bs_mask-wilson-sub.tsv", sep = '\t')
abcd_bs_subthresh$study <- "abcd"
abcd_bs_suprathresh <- read.csv("./output/sample-abcd_type-run_stats-bs_mask-wilson-supra.tsv", sep = '\t')
abcd_bs_suprathresh$study <- "abcd"
# Within Subject
abcd_ws_subthresh <- read.csv("./output/sample-abcd_type-run_stats-ws_mask-wilson-sub.tsv", sep = '\t')
abcd_ws_subthresh$study <- "abcd"
abcd_ws_suprathresh <- read.csv("./output/sample-abcd_type-run_stats-ws_mask-wilson-supra.tsv", sep = '\t')
abcd_ws_suprathresh$study <- "abcd"

# similarity
abcd_similarity <- read.csv("./output/sample-abcd_type-run_stats-similarity.tsv", sep = '\t')
abcd_similarity$study <- "abcd"

# smoothness
abcd_smooth = read.csv("./output/ABCD_ses-baselineYear1Arm1_SmoothEstimates.csv", sep=',')
abcd_smooth$sample = "ABCD"

# efficiency 
abcd_eff <- read.csv("../../ProgressDetails/Aim1c_Reliability/Stage2/output/ABCD/sample-abcd_ses-baselineYear1Arm1_stats-efficiency.tsv", sep = '\t')
abcd_eff$study <- "abcd"

# permutations of icc
abcd_icc_subsamp = read.csv("./output/sample-abcd_ses-baselineYear1Arm1_type-bootsrap_stats-icc.tsv", sep="\t")

```

## AHRB 


```{r include=FALSE}
# ICC
ahrb_icc_subthresh <- read.csv("./output/sample-AHRB_type-run_stats-est_mask-wilson-sub.tsv", sep = '\t')
ahrb_icc_subthresh$study <- "ahrb"
ahrb_icc_suprathresh <- read.csv("./output/sample-AHRB_type-run_stats-est_mask-wilson-supra.tsv", sep = '\t')
ahrb_icc_suprathresh$study <- "ahrb"
ahrb_icc_nacc <- read.csv("./output/sample-AHRB_type-run_stats-est_mask-nacc.tsv", sep = '\t')
ahrb_icc_nacc$study <- "ahrb"

# Between Subject
ahrb_bs_subthresh <- read.csv("./output/sample-AHRB_type-run_stats-bs_mask-wilson-sub.tsv", sep = '\t')
ahrb_bs_subthresh$study <- "ahrb"
ahrb_bs_suprathresh <- read.csv("./output/sample-AHRB_type-run_stats-bs_mask-wilson-supra.tsv", sep = '\t')
ahrb_bs_suprathresh$study <- "ahrb"
# Within Subject
ahrb_ws_subthresh <- read.csv("./output/sample-AHRB_type-run_stats-ws_mask-wilson-sub.tsv", sep = '\t')
ahrb_ws_subthresh$study <- "ahrb"
ahrb_ws_suprathresh <- read.csv("./output/sample-AHRB_type-run_stats-ws_mask-wilson-supra.tsv", sep = '\t')
ahrb_ws_suprathresh$study <- "ahrb"
# similarity
ahrb_similarity <- read.csv("./output/sample-AHRB_type-run_stats-similarity.tsv", sep = '\t')
ahrb_similarity$study <- "ahrb"

# smoothness
ahrb_smooth = read.csv("./output/AHRB_ses-1_SmoothEstimates.csv", sep=',')
ahrb_smooth$sample = "AHRB"

# efficiency 
ahrb_eff <- read.csv("output/sample-AHRB_ses-1_stats-efficiency.tsv", sep = '\t')
ahrb_eff$study <- "ahrb"
```

## MLS 

```{r include=FALSE}
# ICC
mls_icc_subthresh <- read.csv("./output/sample-MLS_type-run_stats-est_mask-wilson-sub.tsv", sep = '\t')
mls_icc_subthresh$study <- "mls"
mls_icc_subthresh <- update_mls_fwhm(mls_icc_subthresh)

mls_icc_suprathresh <- read.csv("./output/sample-MLS_type-run_stats-est_mask-wilson-supra.tsv", sep = '\t')
mls_icc_suprathresh$study <- "mls"
mls_icc_suprathresh <- update_mls_fwhm(mls_icc_suprathresh)

mls_icc_nacc <- read.csv("./output/sample-MLS_type-run_stats-est_mask-nacc.tsv", sep = '\t')
mls_icc_nacc$study <- "mls"
mls_icc_nacc <- update_mls_fwhm(mls_icc_nacc)


# Between Subject
mls_bs_subthresh <- read.csv("./output/sample-MLS_type-run_stats-bs_mask-wilson-sub.tsv", sep = '\t')
mls_bs_subthresh$study <- "mls"
mls_bs_subthresh <- update_mls_fwhm(mls_bs_subthresh)

mls_bs_suprathresh <- read.csv("./output/sample-MLS_type-run_stats-bs_mask-wilson-supra.tsv", sep = '\t')
mls_bs_suprathresh$study <- "mls"
mls_bs_suprathresh <- update_mls_fwhm(mls_bs_suprathresh)

# Within Subject
mls_ws_subthresh <- read.csv("./output/sample-MLS_type-run_stats-ws_mask-wilson-sub.tsv", sep = '\t')
mls_ws_subthresh$study <- "mls"
mls_ws_subthresh <- update_mls_fwhm(mls_ws_subthresh)

mls_ws_suprathresh <- read.csv("./output/sample-MLS_type-run_stats-ws_mask-wilson-supra.tsv", sep = '\t')
mls_ws_suprathresh$study <- "mls"
mls_ws_suprathresh <- update_mls_fwhm(mls_ws_suprathresh)

# similarity
mls_similarity <- read.csv("./output/sample-MLS_type-run_stats-similarity.tsv", sep = '\t')
mls_similarity$study <- "mls"
mls_similarity <- mls_similarity %>%
    mutate(fwhm = case_when(
      fwhm == 3 ~ 3.6,
      fwhm == 4 ~ 4.8,
      fwhm == 5 ~ 6.0,
      fwhm == 6 ~ 7.2,
      fwhm == 7 ~ 8.4,
      TRUE ~ fwhm)  # if none of the conditions match, keep the original value
    )

# smoothness
mls_smooth = read.csv("./output/MLS_ses-1_SmoothEstimates.csv", sep=',')
mls_smooth$sample = "MLS"

# efficiency 
mls_eff <- read.csv("./output/sample-MLS_ses-1_stats-efficiency.tsv", sep = '\t')
mls_eff$study <- "mls"
```

## combine data

```{r message=FALSE, warning=FALSE, include=FALSE}
# ICC
icc_subthresh <- rbind(abcd_icc_subthresh, ahrb_icc_subthresh, mls_icc_subthresh)
icc_subthresh <- icc_subthresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

icc_suprathresh <- rbind(abcd_icc_suprathresh, ahrb_icc_suprathresh, mls_icc_suprathresh)
icc_suprathresh <-  icc_suprathresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

icc_nacc <- rbind(abcd_icc_nacc, ahrb_icc_nacc, mls_icc_nacc)
icc_nacc <-  icc_nacc %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))


# Between Subject
bs_subthresh <- rbind(abcd_bs_subthresh, ahrb_bs_subthresh, mls_bs_subthresh)
bs_subthresh <- bs_subthresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))
bs_suprathresh <- rbind(abcd_bs_suprathresh, ahrb_bs_suprathresh, mls_bs_suprathresh)
bs_suprathresh <-  bs_suprathresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

# Within Subject
ws_subthresh <- rbind(abcd_ws_subthresh, ahrb_ws_subthresh, mls_ws_subthresh)
ws_subthresh <- ws_subthresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))
ws_suprathresh <- rbind(abcd_ws_suprathresh, ahrb_ws_suprathresh, mls_ws_suprathresh)
ws_suprathresh <-  ws_suprathresh %>% mutate(
    con = gsub("contrast-", "", con),
    motion = gsub("mot-", "", motion),
    model = gsub("mod-", "", model),
    fwhm = gsub("fwhm-", "", fwhm)
  ) %>% 
  mutate(con = gsub("-", "", con))

# similarity
similarity_df <- rbind(abcd_similarity,ahrb_similarity, mls_similarity)
similarity_df <-  similarity_df %>% 
  mutate(con = gsub("-", "", con))
similarity_df$fwhm <- as.character(similarity_df$fwhm)

# smoothnesss
comb_smooth = rbind(ahrb_smooth,mls_smooth,abcd_smooth)

# effiiency
efficiency_df <- rbind(abcd_eff,ahrb_eff,mls_eff)

# remove excess files
rm(ahrb_bs_subthresh, ahrb_bs_suprathresh, ahrb_icc_subthresh, ahrb_icc_suprathresh, ahrb_ws_subthresh, ahrb_ws_suprathresh,ahrb_similarity, ahrb_smooth,ahrb_eff,
   abcd_bs_subthresh, abcd_bs_suprathresh, abcd_icc_subthresh, abcd_icc_suprathresh, abcd_ws_subthresh, abcd_ws_suprathresh,abcd_similarity, abcd_smooth, abcd_eff,
   mls_bs_subthresh, mls_bs_suprathresh, mls_icc_subthresh, mls_icc_suprathresh, mls_ws_subthresh, mls_ws_suprathresh,mls_similarity, mls_smooth,mls_eff, mls_icc_nacc, ahrb_icc_nacc, abcd_icc_nacc)
```

# Smoothing + T to D {.tabset}

## Inherent Smoothing

```{r}
smoothing_x = c(1.5,2,2.5,3,3.5)
(smoothing_x*4)
cat((smoothing_x*.5)*4)
```

reporting the smoothness density across 240 group lvl model residual variance maps for ABCD, AHRB and MLS. Five smoothing kernels were used `r cat(smoothing_x)`x voxel-size in 2.4mm for abcd/ahrb, resulting in `r cat(smoothing_x*2.4)` smoothness for ABCD/AHRB and a weight of `.50` was used for MLS 4mm voxel-size resulting in smoothness multiples of `rcat((smoothing_x*.5)*4)`.

SmoothEstimate from FSL was used and Rsel^(1/3) is reported as it is "avg FWHM" based on: https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=FSL;e792b5da.0803
```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
comb_smooth %>% 
  mutate(FWHM_avg = RESEL^(1/3)) %>% 
  ggplot(aes(x=FWHM_avg, fill = sample, colour = sample)) +
  geom_density(alpha = .5) +
  xlab("Avg FWHM") +
  xlim(0,10)+
  ylim(0,.5)+
  scale_fill_manual(values = pal) +  
  scale_colour_manual(values = pal) +
  theme_minimal()
```

```{r}
comb_smooth %>% 
  group_by(sample) %>% 
  summarise(mean = mean(RESEL^(1/3)), sd = sd(RESEL^(1/3))) %>% 
  kbl(format = "html", 
      booktabs = TRUE) %>% 
  kable_styling(full_width = FALSE)
```

## t-stat to cohen's d

```{r}
n_range = seq(5, 200, 1)
result_df <- data.frame(n = numeric(0), 
                        t_stat = numeric(0), cohen_d = numeric(0))
for (n in n_range) {
  set.seed(123)
  n <- n
  population_mean <- 0
  mean <- 5
  sd <- 1
  
  # Generate random samples from a t-distribution
  df <- rnorm(n, mean = mean, sd = sd)
  
  
  # Perform a one-sample t-test
  t_test_result <- t.test(df, mu = population_mean)
  t_stat = t_test_result$statistic 
  cohens_d = t_test_result$statistic / sqrt(n)
  result_df <- rbind(result_df, data.frame(n = n, t_stat = t_stat, cohen_d = cohens_d))
}


result_df %>% 
  ggplot(aes(x = n)) +
  geom_line(aes(y = t_stat, color = "T-statistic"), size = .5) +
  geom_line(aes(y = cohen_d, color = "Cohen's d"), size = .5) +
  labs(caption = "Cohen's d = t-stat / sqrt(n)",
       x = "Sample Size (n)",
       y = "Value") +
  scale_color_manual(values = c("T-statistic" = "black", "Cohen's d" = "red")) +
  theme_minimal()

```


# Plot distributions {.tabset}

Below, running the steps to summarize the different Intraclass correlation (ICC), Mean Squared Between Subject (Between Subject), Mean Square Within Subject (Within Subject), and jaccard and spearman similarty for the model combinations `r 5*6*3*4` across samples

## ICC

Plotting overall and for each of [four] categories

### Subthreshold Mask

Creating rainclouds via [ggrain](https://cran.r-project.org/web/packages/ggrain/vignettes/ggrain.html)

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(icc_subthresh, y_est = "median_est", y_min =-.1, y_max=.6, y_lab = "Median ICC")
fwhm_rg = create_plot(icc_subthresh, y_est = "median_est", type = "fwhm",  thresh = "sub-threshold", 
                      y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
motion_rg = create_plot(icc_subthresh, y_est = "median_est", type = "motion", thresh = "sub-threshold", 
                        y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
modeltype_rg = create_plot(icc_subthresh, y_est = "median_est", type = "model", thresh = "sub-threshold",
                           y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
contrast_rg = create_plot(icc_subthresh, y_est = "median_est", type = "con", thresh = "sub-threshold", 
                          y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for sub-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```


### Suprathreshold Mask


```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(icc_suprathresh, y_est = "median_est", y_min=-.1, y_max=.6, y_lab = "Median ICC")
fwhm_rg = create_plot(icc_suprathresh, y_est = "median_est", type = "fwhm",  thresh = "supra-threshold", 
                      y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
motion_rg = create_plot(icc_suprathresh, y_est = "median_est", type = "motion", thresh = "supra-threshold", 
                        y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
modeltype_rg = create_plot(icc_suprathresh, y_est = "median_est", type = "model", thresh = "supra-threshold",
                           y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)
contrast_rg = create_plot(icc_suprathresh, y_est = "median_est", type = "con", thresh = "supra-threshold", 
                          y_min=-.1, y_max=.6, y_lab = "Median ICC", add_title=FALSE)


cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for supra-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

### Nacc avg Mask

#### Right

```{r, fig.width=16, fig.height=10}
fwhm_rg = create_plot(icc_nacc, y_est = "avg_right", "fwhm","Avg Right NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
motion_rg = create_plot(icc_nacc, y_est = "avg_right", "motion","Avg Right NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
modeltype_rg = create_plot(icc_nacc, y_est = "avg_right", "model","Avg Right NAcc",y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
contrast_rg = create_plot(icc_nacc, y_est = "avg_right", "con","Avg Right NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for Right NAcc")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
```


#### Left 

```{r, fig.width=16, fig.height=10}
fwhm_rg = create_plot(icc_nacc, y_est = "avg_left", "fwhm","Avg Left NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
motion_rg = create_plot(icc_nacc, y_est = "avg_left", "motion","Avg Left NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
modeltype_rg = create_plot(icc_nacc, y_est = "avg_left", "model","Avg Left NAcc",y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)
contrast_rg = create_plot(icc_nacc, y_est = "avg_left", "con","Avg Left NAcc", y_min=-.3, y_max=.6, y_lab = "ICC", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for Left NAcc")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
```

## Between Subject

Plotting overall and for each of [four] categories

### Subthreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(bs_subthresh, y_est = "median_est", y_min=-.01, y_max=2, y_lab = "Median Between Subject")
fwhm_rg = create_plot(bs_subthresh, y_est = "median_est", type = "fwhm",  thresh = "sub-threshold", 
                      y_min=-.01, y_max=2, y_lab = "Median Between Subject", add_title=FALSE)
motion_rg = create_plot(bs_subthresh, y_est = "median_est", type = "motion", thresh = "sub-threshold", 
                        y_min=-.01, y_max=2, y_lab = "Median Between Subject", add_title=FALSE)
modeltype_rg = create_plot(bs_subthresh, y_est = "median_est", type = "model", thresh = "sub-threshold",
                           y_min=-.01, y_max=2, y_lab = "Median Between Subject", add_title=FALSE)
contrast_rg = create_plot(bs_subthresh, y_est = "median_est", type = "con", thresh = "sub-threshold", 
                          y_min=-.01, y_max=2, y_lab = "Median Between Subject", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for sub-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

### Suprathreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(bs_suprathresh, y_est = "median_est", y_min=-1, y_max=2, y_lab = "Median Between Subject")
fwhm_rg = create_plot(bs_suprathresh, y_est = "median_est", type = "fwhm",  thresh = "supra-threshold", 
                      y_min=-.01, y_max=2, y_lab = "Median Between Subject", add_title=FALSE)
motion_rg = create_plot(bs_suprathresh, y_est = "median_est", type = "motion", thresh = "supra-threshold", 
                        y_min=-.01, y_max=2, y_lab = "Median Between Subject", add_title=FALSE)
modeltype_rg = create_plot(bs_suprathresh, y_est = "median_est", type = "model", thresh = "supra-threshold",
                           y_min=-.01, y_max=2, y_lab = "Median Between Subject", add_title=FALSE)
contrast_rg = create_plot(bs_suprathresh, y_est = "median_est", type = "con", thresh = "supra-threshold", 
                          y_min=-.01, y_max=2, y_lab = "Median Between Subject", add_title=FALSE)


cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for supra-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```


## Within Subject

Plotting overall and for each of [four] categories

### Subthreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(ws_subthresh, y_est = "median_est", y_min=0, y_max=7, y_lab = "Median Within Subject")
fwhm_rg = create_plot(ws_subthresh, y_est = "median_est", type = "fwhm",  thresh = "sub-threshold", 
                      y_min=0, y_max=7, y_lab = "Median Within Subject", add_title=FALSE)
motion_rg = create_plot(ws_subthresh, y_est = "median_est", type = "motion", thresh = "sub-threshold", 
                        y_min=0, y_max=7, y_lab = "Median Within Subject", add_title=FALSE)
modeltype_rg = create_plot(ws_subthresh, y_est = "median_est", type = "model", thresh = "sub-threshold",
                           y_min=0, y_max=7, y_lab = "Median Within Subject", add_title=FALSE)
contrast_rg = create_plot(ws_subthresh, y_est = "median_est", type = "con", thresh = "sub-threshold", 
                          y_min=0, y_max=7, y_lab = "Median Within Subject", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for sub-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

### Suprathreshold Mask

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(ws_suprathresh, y_est = "median_est", y_min=0, y_max=7, y_lab = "Median Within Subject")
fwhm_rg = create_plot(ws_suprathresh, y_est = "median_est", type = "fwhm",  thresh = "supra-threshold", 
                      y_min=0, y_max=7, y_lab = "Median Within Subject", add_title=FALSE)
motion_rg = create_plot(ws_suprathresh, y_est = "median_est", type = "motion", thresh = "supra-threshold", 
                        y_min=0, y_max=7, y_lab = "Median Within Subject", add_title=FALSE)
modeltype_rg = create_plot(ws_suprathresh, y_est = "median_est", type = "model", thresh = "supra-threshold",
                           y_min=0, y_max=7, y_lab = "Median Within Subject", add_title=FALSE)
contrast_rg = create_plot(ws_suprathresh, y_est = "median_est", type = "con", thresh = "supra-threshold", 
                          y_min=0, y_max=7, y_lab = "Median Within Subject", add_title=FALSE)

cat("Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast for supra-threshold mask")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```


## Similarity

### jaccard

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(similarity_df, y_est = "jaccard", y_min=0, y_max = 1, y_lab = "Jaccard")

fwhm_rg = create_plot(similarity_df, y_est = "jaccard", type = "fwhm", thresh = "Jaccard", 
                      y_min=0, y_max = 1, y_lab = "Jaccard", add_title=FALSE)
motion_rg = create_plot(similarity_df, y_est = "jaccard", type = "motion", thresh = "Jaccard", 
                        y_min=0, y_max = 1, y_lab = "Jaccard", add_title=FALSE)
modeltype_rg = create_plot(similarity_df, y_est = "jaccard", type = "model", thresh="Jaccrd", 
                           y_min=0, y_max = 1, y_lab = "Jaccard", add_title=FALSE)
contrast_rg = create_plot(similarity_df, y_est = "jaccard", type = "con", thresh = "Jaccard", 
                          y_min=0, y_max = 1, y_lab = "Jaccard", add_title=FALSE)

cat("Jaccard: Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

### spearman

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(similarity_df, y_est = "spearman", y_min=0, y_max = 1, y_lab = "Spearman")

fwhm_rg = create_plot(similarity_df, y_est = "spearman", type = "fwhm", thresh = "Spearman", 
                      y_min=0, y_max = 1, y_lab = "Spearman", add_title=FALSE)
motion_rg = create_plot(similarity_df, y_est = "spearman", type = "motion", thresh = "Spearman", 
                        y_min=0, y_max = 1, y_lab = "Spearman", add_title=FALSE)
modeltype_rg = create_plot(similarity_df, y_est = "spearman", type = "model", thresh="Spearman", 
                           y_min=0, y_max = 1, y_lab = "Spearman", add_title=FALSE)
contrast_rg = create_plot(similarity_df, y_est = "spearman", type = "con", thresh = "Spearman", 
                          y_min=0, y_max = 1, y_lab = "Spearman", add_title=FALSE)

cat("Spearman: Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset

```

## Group Cohen's ~ ICC 

```{r, fig.width=16, fig.height=10}
cohens_sim <- gather(similarity_df, key = "Run", value = "spearman", run1_icc_cohensd:run2_icc_cohensd) %>% 
  mutate(Run = case_when(
    Run == "run1_icc_cohensd" ~ "Run1",
    Run == "run2_icc_cohensd" ~ "Run2",
    TRUE ~ Run
  ))
```

```{r, fig.width=16, fig.height=10}
cat("\tICC, Between Subject and Within Subject median, miniumum and maximum")
calculate_summary_stats(similarity_df, run1_icc_cohensd, "ICC ~ R1 Cohen's D")
calculate_summary_stats(similarity_df, run2_icc_cohensd, "ICC ~ R2 Cohen's D")
```


```{r, fig.width=16, fig.height=10}
cohens_sim %>% ggplot(aes(x = fwhm, y = spearman, fill = fwhm, color = fwhm)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .2), width = 0.1
            )) +
  facet_grid(~study + Run) +
  theme_classic() +
  ggtitle("Distribution by FWHM category") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))

cohens_sim %>% ggplot(aes(x = con, y = spearman, fill = con, color = con)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .2), width = 0.1
            )) +
  facet_grid(~study + Run) +
  theme_classic() +
  ggtitle("Distribution by Contrast category") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))


cohens_sim %>% ggplot(aes(x = motion, y = spearman, fill = motion, color = motion)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .2), width = 0.1
            )) +
  facet_grid(~study + Run) +
  theme_classic() +
  ggtitle("Distribution by Motion category") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))

cohens_sim %>% ggplot(aes(x = model, y = spearman, fill = model, color = model)) +
  geom_rain(alpha = .5, rain.side = 'l',
            boxplot.args = list(color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .2), width = 0.1
            )) +
  facet_grid(~study + Run) +
  theme_classic() +
  ggtitle("Distribution by Model category") +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  guides(fill = 'none', color = 'none') +
  theme(text = element_text(family = "Times New Roman"),
        axis.text = element_text(size = 12, angle = 45, hjust = 1),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))

cat("Spearman: Plotting A = Motion; B = FWHM; C = Model Parameterization, D = Contrast")
(motion_rg | fwhm_rg) / (modeltype_rg | contrast_rg) + plot_annotation(tag_levels = c("A","B","C","D")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
```

## Dev Comp.

### Full 

```{r}
older <- icc_suprathresh %>% filter(study %in% c('mls', 'ahrb')) 
younger <- icc_suprathresh %>% filter(study == 'abcd') 

cat("Comparing (x) older samples AHRB/MLS (n = ", nrow(older),")", "versus (y) younger sample ABCD (n = ", nrow(younger),")")

t.test(older$median_est, younger$median_est)
effectsize::cohens_d(older$median_est, younger$median_est, pooled = TRUE)
```

### FWHM 

```{r}
filtered_df <- icc_suprathresh %>%
  filter(motion == 'opt1' & model == 'CueMod' & con == 'LgainNeut')

older <- filtered_df %>% filter(study %in% c('mls', 'ahrb')) 
younger <- filtered_df %>% filter(study == 'abcd') 

cat("Comparing (x) older samples AHRB/MLS (n = ", nrow(older),")", "versus (y) younger sample ABCD (n = ", nrow(younger),")")
t.test(older$median_est, younger$median_est)
effectsize::cohens_d(older$median_est, younger$median_est, pooled = TRUE)
```

### Model Parameterization 

```{r}
filtered_df <- icc_suprathresh %>%
  filter(motion == 'opt1' & fwhm == '4.8' & con == 'LgainNeut')

# Separate the fwhm values based on study groups
older <- filtered_df %>% filter(study %in% c('mls', 'ahrb')) 
younger <- filtered_df %>% filter(study == 'abcd') 

cat("Comparing (x) older samples AHRB/MLS (n = ", nrow(older),")", "versus (y) younger sample ABCD (n = ", nrow(younger),")")
t.test(older$median_est, younger$median_est)
effectsize::cohens_d(older$median_est, younger$median_est, pooled = TRUE)
```

### Contrasts

```{r}
filtered_df <- icc_suprathresh %>%
  filter(con == 'LgainNeut' & fwhm == '3.6' & model == 'FixMod')

# Separate the fwhm values based on study groups
older <- filtered_df %>% filter(study %in% c('mls', 'ahrb')) 
younger <- filtered_df %>% filter(study == 'abcd') 

cat("Comparing (x) older samples AHRB/MLS (n = ", nrow(older),")", "versus (y) younger sample ABCD (n = ", nrow(younger),")")
t.test(older$median_est, younger$median_est)
effectsize::cohens_d(older$median_est, younger$median_est, pooled = TRUE)
```

### Motion

```{r}
filtered_df <- icc_suprathresh %>%
  filter(con == 'LgainNeut' & fwhm == '3.6' & model == 'FixMod')

# Separate the fwhm values based on study groups
older <- filtered_df %>% filter(study %in% c('mls', 'ahrb')) 
younger <- filtered_df %>% filter(study == 'abcd') 

cat("Comparing (x) older samples AHRB/MLS (n = ", nrow(older),")", "versus (y) younger sample ABCD (n = ", nrow(younger),")")
t.test(older$median_est, younger$median_est)
effectsize::cohens_d(older$median_est, younger$median_est, pooled = TRUE)
```

## Model Effieincy, ses-1

```{r, fig.width=16, fig.height=10}
subset <- by_sample_conmod(efficiency_df, y_est = "eff_est", y_min = 0, y_max = 15, y_lab = "Efficiency Estimate")
motion_rg = create_plot(efficiency_df, y_est = "eff_est", "motion","Efficiency", 
                        y_min = 0, y_max = 15, y_lab = "Efficiency Estimate", add_title=FALSE)
modeltype_rg = create_plot(efficiency_df, y_est = "eff_est", "model","Efficiency", 
                           y_min = 0, y_max = 15, y_lab = "Efficiency Estimate", add_title=FALSE)
contrast_rg = create_plot(efficiency_df, y_est = "eff_est", "con","Efficiency", 
                          y_min = 0, y_max = 15, y_lab = "Efficiency Estimate",  add_title=FALSE)


cat("Plotting A = Motion; B = Model Parameterization, C = Contrast for Efficiency")
(motion_rg) / (modeltype_rg + contrast_rg) + plot_annotation(tag_levels = c("A","B","C")) & theme(plot.tag = element_text(size = 30, face = "bold")) 
subset
```

# Med/Min/Max Across Models {.tabset}
`

## Subtreshold

```{r}
cat("Subthreshold mask")
cat("\tICC, Between Subject and Within Subject median, miniumum and maximum")
calculate_summary_stats(icc_subthresh, median_est, "ICC")
calculate_summary_stats(bs_subthresh, median_est, "Between Subject")
calculate_summary_stats(ws_subthresh, median_est, "Within Subject")
```

## Suprathreshold
```{r message=FALSE, warning=FALSE}
cat("Suprathreshold mask")
cat("\tICC, Between Subject and Within Subject median, miniumum and maximum")
calculate_summary_stats(icc_suprathresh, median_est, "ICC")
calculate_summary_stats(bs_suprathresh, median_est, "Between Subject")
calculate_summary_stats(ws_suprathresh, median_est, "Within Subject")
```

## simlarity

```{r}
cat("Similarity median, minimum and maximum for jaccard and spearman")
calculate_summary_stats(similarity_df, jaccard, "Jaccard")
calculate_summary_stats(similarity_df, spearman, "Spearman")
```


## NAcc

```{r message=FALSE, warning=FALSE}
cat("\tICC Right and Left avg ICC, miniumum and maximum")
calculate_summary_stats(icc_nacc, avg_right, "Right avg ICC")
calculate_summary_stats(icc_nacc, avg_left, "Left avg ICC")
```

# Specification Curve {.tabset}

Creating data in a format that is compatible with [specr](https://cran.r-project.org/web/packages/specr/specr.pdf). Needs: estimate (i.e., ICC), std.error, conf.high, conf.low.


## ICC


### suprathreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
# first, combine independent model vars into string to create average for each model type
icc_suprathresh$model_type <- paste(icc_suprathresh$fwhm, icc_suprathresh$motion,
                                    icc_suprathresh$con,  icc_suprathresh$model,
                                    sep = "_")

# calculate the avg estimate of ICC across study, standard error and +/- 95% confidence interval. In complete version
df_summ <- icc_suprathresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "supra-threshold ICC"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "supra-threshold ICC"
create_specr_plot(df_summ_subset, est_label)
```

### subthreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
icc_subthresh$model_type <- paste(icc_subthresh$fwhm, icc_subthresh$motion,
                                  icc_subthresh$con,  icc_subthresh$model,
                                  sep = "_")

df_summ <- icc_subthresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "sub-threshold ICC"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "sub-threshold ICC"
create_specr_plot(df_summ_subset, est_label)
```


### NAcc Avg 

#### Left NAcc

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
# first, combine independent model vars into string to create average for each model type
icc_nacc$model_type <- paste(icc_nacc$fwhm, icc_nacc$motion,
                             icc_nacc$con,  icc_nacc$model,
                             sep = "_")

# calculate the avg estimate of ICC across study, standard error and +/- 95% confidence interval. In complete version
df_summ <- icc_nacc %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(avg_left), std.error = sd(avg_left)/sqrt(length(avg_left))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "Left NAcc ICC"
create_specr_plot(df_summ, est_label)

```

estimate variability across samples
```{r}
# median + variable for top
icc_nacc %>% 
  filter(model_type=='8.4_opt1_SgainBase_CueMod' | model_type=='8.4_opt1_LgainBase_CueMod' | model_type=='8.4_opt1_LgainNeut_CueMod')
```

#### Right NAcc

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
# first, combine independent model vars into string to create average for each model type
icc_nacc$model_type <- paste(icc_nacc$fwhm, icc_nacc$motion,
                             icc_nacc$con,  icc_nacc$model,
                             sep = "_")

# calculate the avg estimate of ICC across study, standard error and +/- 95% confidence interval. In complete version
df_summ <- icc_nacc %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(avg_right), std.error = sd(avg_right)/sqrt(length(avg_right))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "Right NAcc ICC"
create_specr_plot(df_summ, est_label)
```


## Between Subject

### suprathreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
bs_suprathresh$model_type <- paste(bs_suprathresh$fwhm, bs_suprathresh$motion,
                                   bs_suprathresh$con,  bs_suprathresh$model,
                                   sep = "_")

df_summ <- bs_suprathresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "supra-threshold Between Subject"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "supra-threshold Between Subject"
create_specr_plot(df_summ_subset, est_label)
```

### subthreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
bs_subthresh$model_type <- paste(bs_subthresh$fwhm, bs_subthresh$motion,
                                 bs_subthresh$con,  bs_subthresh$model,
                                 sep = "_")


df_summ <- bs_subthresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "sub-threshold Between Subject"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "suprathreshold Between Subject"
create_specr_plot(df_summ_subset, est_label)
```


## Within Subject

### suprathreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
ws_suprathresh$model_type <- paste(ws_suprathresh$fwhm, ws_suprathresh$motion,
                                   bs_suprathresh$con,  ws_suprathresh$model,
                                   sep = "_")

df_summ <- ws_suprathresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "supra-threshold Within Subject"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "supra-threshold Within Subject"
create_specr_plot(df_summ_subset, est_label)
```

### subthreshold 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r fig.height=6, fig.width=5, warning=FALSE}
ws_subthresh$model_type <- paste(ws_subthresh$fwhm, ws_subthresh$motion,
                                 ws_subthresh$con,  ws_subthresh$model,
                                 sep = "_")

# calculate the avg estimate of ICC across study, standard error and +/- 95% confidence interval. In complete version
df_summ <- ws_subthresh %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(median_est), std.error = sd(median_est)/sqrt(length(median_est))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "sub-threshold Within Subject"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r fig.height=6, fig.width=5, warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subplot
est_label = "sub-threshold Within Subject"
create_specr_plot(df_summ_subset, est_label)
```

## Similarity

### Jaccard 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r warning=FALSE}
similarity_df$model_type <- paste(similarity_df$fwhm, similarity_df$motion,
                                  similarity_df$con, similarity_df$model,
                                  sep = "_")

df_summ <- similarity_df %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(jaccard), std.error = sd(jaccard)/sqrt(length(jaccard))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "Jaccard"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "Jaccard"
create_specr_plot(df_summ_subset, est_label)
```

### Spearman 

#### All models

creating combined panel 1 and panel 2 for all model permutations first.

```{r warning=FALSE}
similarity_df$model_type <- paste(similarity_df$fwhm, similarity_df$motion,
                                  similarity_df$con,  similarity_df$model, 
                                  sep = "_")

# calculate the avg estimate of ICC across study, standard error and +/- 95% confidence interval. In complete version
df_summ <- similarity_df %>% 
  group_by(model_type) %>% 
  summarise(estimate = mean(spearman), std.error = sd(spearman)/sqrt(length(spearman))) %>% 
  mutate(conf.low = estimate - 1.96 * std.error, conf.high = estimate + 1.96 * std.error) %>% 
  separate(col = model_type, into = c("fwhm","motion","contrast","model"), sep = "_|-", remove = FALSE)

# plot
est_label = "Spearman"
create_specr_plot(df_summ, est_label)
```


#### subset models

Creating model that is subset to visualize reliability for the top (>75th) and bottom (< 25th) quartile

```{r warning=FALSE}
# get 75th/25th qunatiles
top_75q = as.numeric(quantile(df_summ$estimate, .75))
bot_25q = as.numeric(quantile(df_summ$estimate, .25))
df_summ_subset = df_summ %>% 
  filter(estimate < bot_25q | estimate > top_75q)

# subset plots
est_label = "Spearman"
create_specr_plot(df_summ_subset, est_label)
```


# ICC parameter subsampling {.tabset}

We state:

Aim 3: *evaluates the sample size at which the ICC stabilizes. The chosen pipeline will be based on the highest median ICC across the studies for the suprathreshold task-positive mask from Aim 1a that will be rerun for the ABCD sample. Based on this pipeline, the first-level analysis steps are repeated for N = 525 from the N = 2000 subsample for only the ABCD data. Then, voxelwise_icc within the brain_icc.py script is used to derive estimates of the median ICC, Between Subject and Within Subject for the between runs (e.g., measurement occasions) reliability across randomly sampled subjects for 25 to 525 subjects in intervals of 50. Similar to the methods in Liu et al. (2023), 100 iterations are performed at each N (with replacement) and the median ICC, the associated Between Subject and Within Subject estimates are retained from voxelwise_icc. The average and standard error across the 100 iterations is plotted for each interval of N with the y-axis representing the ICC and x-axis representing N.  The plotted values will be used to infer change and stability in the estimated median ICCs and variance components across the sample size. If stability is not achieved by N = 500, the sample is extended to N = 1,000 and the analyses are repeated.*

```{r}
icc_subsamp_lg <- abcd_icc_subsamp %>%
  gather(key, value, starts_with(c("icc_", "msbtwn_", "mswthn_"))) %>%
  separate(key, into = c("variable", "mask"), sep = "_") %>%
  spread(variable, value)

```

```{r}
n_range = seq(25,525,50)
```

## ICC

```{r}
icc_summary <- icc_subsamp_lg %>%
  group_by(mask,subsample_n) %>%
  summarize(mean_icc = mean(icc),
            lower_ci = quantile(icc, 0.025),
            upper_ci = quantile(icc, 0.975))

ggplot() +
  # add individual lines of ICC fo subsample_n + add mean
  geom_path(data = icc_subsamp_lg, aes(x = subsample_n, y = icc, group = as.factor(seed)),
            alpha = 0.1) +  # Use geom_path to connect individual points
  geom_line(data = icc_summary, aes(x = subsample_n, y = mean_icc), alpha = .5) + 
  # create ribbon + 95CI upper/lower
  geom_ribbon(data = icc_summary, aes(x = subsample_n, ymin = lower_ci, ymax = upper_ci), 
              alpha = 0.1) +  
  geom_line(data = icc_summary, aes(x = subsample_n, y = lower_ci), linetype = "dashed", color = "red") +
  geom_line(data = icc_summary, aes(x = subsample_n, y = upper_ci), linetype = "dashed", color = "red") +  
  labs(title = "Individual points, Mean & +/-95% CI of ICC point estimate across 100 bootstraps at each N", 
       subtitle = paste0("N=25 (Max:", 
                        round(max(icc_subsamp_lg %>% filter(subsample_n == 25) %>% pull(icc)), 2),
                        " Min:", 
                        round(min(icc_subsamp_lg %>% filter(subsample_n == 25) %>% pull(icc)), 2),
                        ") N=525 (Max:", 
                        round(max(icc_subsamp_lg %>% filter(subsample_n == 525) %>% pull(icc)), 2),
                        " Min:", 
                        round(min(icc_subsamp_lg %>% filter(subsample_n == 525) %>% pull(icc)), 2)
                        ,")"),
       caption = paste("N range:",
                       paste(n_range, collapse = ", "),
                       "\n100 random iterations per N"),
       x = "", y = "Median ICC") +
  ylim(0, 0.75) +
  facet_wrap(~ mask) +
  theme_minimal()
```

```{r}
icc_supra <- icc_subsamp_lg %>%
  filter(mask=="supra") %>% 
  group_by(subsample_n) %>%
  summarize(mean_icc = mean(icc),
            lower_ci = quantile(icc, 0.025),
            upper_ci = quantile(icc, 0.975))

icc_supra_lg = icc_subsamp_lg %>% 
  filter(mask=="supra")

ggplot() +
  # add individual lines of ICC fo subsample_n + add mean
  geom_path(data = icc_supra_lg, aes(x = subsample_n, y = icc, group = as.factor(seed)),
            alpha = 0.1) +  # Use geom_path to connect individual points
  geom_line(data = icc_supra, aes(x = subsample_n, y = mean_icc), alpha = .5) + 
  # create ribbon + 95CI upper/lower
  geom_ribbon(data = icc_supra, aes(x = subsample_n, ymin = lower_ci, ymax = upper_ci), 
              alpha = 0.1) +  
  geom_line(data = icc_supra, aes(x = subsample_n, y = lower_ci), linetype = "dashed", color = "red") +
  geom_line(data = icc_supra, aes(x = subsample_n, y = upper_ci), linetype = "dashed", color = "red") +  
  labs(title = "Individual points, Mean & +/-95% CI of ICC point estimate across 100 bootstraps at each N", 
       subtitle = paste0("N=25 (Max:", 
                        round(max(icc_supra_lg %>% filter(subsample_n == 25) %>% pull(icc)), 2),
                        " Min:", 
                        round(min(icc_supra_lg %>% filter(subsample_n == 25) %>% pull(icc)), 2),
                        ") N=525 (Max:", 
                        round(max(icc_supra_lg %>% filter(subsample_n == 525) %>% pull(icc)), 2),
                        " Min:", 
                        round(min(icc_supra_lg %>% filter(subsample_n == 525) %>% pull(icc)), 2)
                        ,")"),
       caption = paste("N range:",
                       paste(n_range, collapse = ", "),
                       "\n100 random iterations per N"),
       x = "", y = "Median ICC") +
  ylim(0, 0.75) +
  theme_minimal()
```

## Between Subject

```{r}
between_sub <- icc_subsamp_lg %>%
  group_by(mask,subsample_n) %>%
  summarize(mean_msbthn = mean(msbtwn),
            lower_ci = quantile(msbtwn, 0.025),
            upper_ci = quantile(msbtwn, 0.975))

ggplot() +
  # add individual lines of ICC fo subsample_n + add mean
  geom_path(data = icc_subsamp_lg, aes(x = subsample_n, y = msbtwn, group = as.factor(seed)),
            alpha = 0.1) +  # Use geom_path to connect individual points
  geom_line(data = between_sub, aes(x = subsample_n, y = mean_msbthn), alpha = .5) + 
  # create ribbon + 95CI upper/lower
  geom_ribbon(data = between_sub, aes(x = subsample_n, ymin = lower_ci, ymax = upper_ci), 
              alpha = 0.1) +  
  geom_line(data = between_sub, aes(x = subsample_n, y = lower_ci), linetype = "dashed", color = "red") +
  geom_line(data = between_sub, aes(x = subsample_n, y = upper_ci), linetype = "dashed", color = "red") +  
  labs(title = "Individual points, Mean & +/-95% CI of Between Subject point estimate across 100 bootstraps at each N", 
       subtitle = paste0("N=25 (Max:", 
                        round(max(icc_subsamp_lg %>% filter(subsample_n == 25) %>% pull(msbtwn)), 2),
                        " Min:", 
                        round(min(icc_subsamp_lg %>% filter(subsample_n == 25) %>% pull(msbtwn)), 2),
                        ") N=525 (Max:", 
                        round(max(icc_subsamp_lg %>% filter(subsample_n == 525) %>% pull(msbtwn)), 2),
                        " Min:", 
                        round(min(icc_subsamp_lg %>% filter(subsample_n == 525) %>% pull(msbtwn)), 2)
                        ,")"),
       caption = paste("N range:",
                       paste(n_range, collapse = ", "),
                       "\n100 random iterations per N"),
       x = "", y = "Median Between Subject") +
  ylim(-0.5, 1) +
  facet_wrap(~ mask) +
  theme_minimal()
```

## Within Subject

```{r}
within_subject <- icc_subsamp_lg %>%
  group_by(mask,subsample_n) %>%
  summarize(mean_mswthn = mean(mswthn),
            lower_ci = quantile(mswthn, 0.025),
            upper_ci = quantile(mswthn, 0.975))

ggplot() +
  # add individual lines of ICC fo subsample_n + add mean
  geom_path(data = icc_subsamp_lg, aes(x = subsample_n, y = mswthn, group = as.factor(seed)),
            alpha = 0.1) +  # Use geom_path to connect individual points
  geom_line(data = within_subject, aes(x = subsample_n, y = mean_mswthn), alpha = .5) + 
  # create ribbon + 95CI upper/lower
  geom_ribbon(data = within_subject, aes(x = subsample_n, ymin = lower_ci, ymax = upper_ci), 
              alpha = 0.1) +  
  geom_line(data = within_subject, aes(x = subsample_n, y = lower_ci), linetype = "dashed", color = "red") +
  geom_line(data = within_subject, aes(x = subsample_n, y = upper_ci), linetype = "dashed", color = "red") +  
  labs(title = "Individual points, Mean & +/-95% CI of Within Subject point estimate across 100 bootstraps at each N", 
       subtitle = paste0("N=25 (Max:", 
                        round(max(icc_subsamp_lg %>% filter(subsample_n == 25) %>% pull(msbtwn)), 2),
                        " Min:", 
                        round(min(icc_subsamp_lg %>% filter(subsample_n == 25) %>% pull(msbtwn)), 2),
                        ") N=525 (Max:", 
                        round(max(icc_subsamp_lg %>% filter(subsample_n == 525) %>% pull(msbtwn)), 2),
                        " Min:", 
                        round(min(icc_subsamp_lg %>% filter(subsample_n == 525) %>% pull(msbtwn)), 2)
                        ,")"),
       caption = paste("N range:",
                       paste(n_range, collapse = ", "),
                       "\n100 random iterations per N"),
       x = "", y = "Median Within Subject") +
  ylim(-.5, 2) +
  facet_wrap(~ mask) +
  theme_minimal()
```
